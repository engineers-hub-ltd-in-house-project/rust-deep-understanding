# 第 20 章：パッケージ、クレート、モジュール

## この章のゴール
- パッケージ、クレート、モジュールの違いと、それぞれの役割を説明できる。
- `mod` キーワードを使って、単一ファイル内のコードを整理したり、別ファイルに分割したりできるようになる。
- `pub` キーワードの必要性を、コンパイルエラー「function is private」を通して説明できる。
- `use` キーワードを使って、他のモジュールへのパスを短縮し、コードの可読性を上げられる。
- `super` キーワードを使って、親モジュールからの相対パスでアイテムを参照できる。
- `struct` や `enum` のフィールドを `pub` にして、外部からのアクセスを許可できる。

---

## 20.1 全体像：パッケージ > クレート > モジュール

Rustのコード構成の単位は、大きい順に「パッケージ」「クレート」「モジュール」となります。

- パッケージ (Package): `cargo new` で作られる、一つの機能を提供する単位。`Cargo.toml` を一つ含み、一つ以上のクレート（ライブラリまたはバイナリ）を持つ。
- クレート (Crate): コンパイルの単位。`rustc` が一度にコンパイルするソースコードの集まり。ライブラリクレート（他のプログラムから利用される）か、バイナリクレート（実行可能ファイルになる）のどちらか。
- モジュール (Module): クレート内のコードを整理し、名前空間を分割するための単位。`mod` キーワードで定義する。

## 20.2 パッケージとクレート

`cargo new` で作られるのは パッケージ です。

```sh
cargo new
```

で作られるのはパッケージです。
    - 1つのパッケージは、最大1つのライブラリクレートと、複数のバイナリクレートを含むことができます。

`src/lib.rs` が存在すれば、それは `my-library` という名前のライブラリクレートのルートになります。

## 20.3 モジュールによるスコープとプライバシーの制御

モジュールは、クレート内のコードをグループ化し、名前空間を分割するための仕組みです。これにより、コードの整理と、詳細の隠蔽（カプセル化）が可能になります。

```rust
// src/main.rs

// `src/client.rs` ファイルを `client` モジュールとして宣言する
mod client;

mod network {
    // この関数を `main` から呼べるようにするには `pub` が必要
    pub fn connect() {
        println!("network::connect() called");
    }
}

fn main() {
    // client モジュールの connect を呼び出す
    client::connect();
    
    // network モジュールの connect を呼び出す
    network::connect();
}
```
でプロジェクトを作り、モジュールの基本的な使い方を学びましょう。

### `mod` と `use`

```rust
// src/main.rs
mod client;
mod network;

// `mod` キーワードは、コードを論理的なグループ（モジュール）に分割するために使用されます。
// `mod front_of_house;` は、`src/front_of_house.rs` というファイル、または `src/front_of_house/mod.rs` というファイルを読み込んで `front_of_house` モジュールを定義します。

## 20.4 `pub` で公開範囲を制御する

デフォルトでは、モジュール内のすべてのアイテム（関数、`struct`、`enum` など）は プライベート です。つまり、親モジュールや外部からはアクセスできません。

```rust
// src/main.rs
mod client;
mod network;

// `pub` キーワードは、モジュール内のアイテムを公開（外部からアクセス可能）にするために使用されます。
// `pub fn connect() { ... }` のように、関数を `pub` にすると、その関数はモジュールの外から呼び出すことができます。

## 20.5 `super` とファイルシステム

- `super`: `super::hosting::add_to_waitlist();` のように、現在のモジュールから見て一つ親のモジュールを指す相対パスです。

## 20.6 まとめ

- パッケージは `Cargo.toml` を持つビルド単位、クレートはコンパイル単位、モジュールはコードの整理と名前空間の単位。
- `cargo new` で作成されるのはパッケージで、`src/main.rs` がバイナリクレートのルート、`src/lib.rs` がライブラリクレートのルートになる。
- `mod` は、コードを整理・カプセル化するための名前空間を作成する。
- `mod my_module;` は、`src/my_module.rs` ファイルをモジュールとして読み込む宣言。
- デフォルトですべてのアイテムはプライベート。`pub` を付けることでモジュール外に公開される。
- `use` は、他のモジュールへのパスを現在のスコープに持ち込み、コードを簡潔にする。
- `struct` や `enum` は、フィールドごとに公開・非公開を設定できる。

---

これで、大規模なプロジェクトでもコードを整理し、メンテナンス性を高く保つための基本的なツールを学びました。次の章では、テストの書き方について学び、コードの品質と信頼性を確保する方法を探求します。
