# 第 21 章：ドキュメントとベストプラクティス

## この章のゴール
- `///` と `//!` を使って、効果的なドキュメンテーションコメントを記述できる。
- `cargo doc` コマンドを使って、プロジェクトのドキュメントを HTML として生成・閲覧できる。
- ドキュメントにコード例を含め、それがテストされる（ドキュメンテーションテスト）ことの重要性を理解する。
- `rustfmt` と `clippy` を使って、コードのフォーマットを統一し、潜在的な問題を検出できる。
- API 設計における一般的なガイドラインを理解する。

## 前章の復習
前の章では、単体テスト、統合テスト、ドキュメンテーションテストの書き方を学びました。`cargo test` を使ってコードの正しさを自動的に検証する方法を習得しました。

## なぜこれが必要なのか？
動くコードを書くだけでは十分ではありません。将来の自分や他の開発者がそのコードを読んだときに、何をするためのコードなのか、どう使えばいいのかを容易に理解できなければ、保守や拡張が困難になります。良いドキュメントと、一貫性のあるコーディングスタイルは、長期的に見てソフトウェアの品質を大きく左右します。

## ドキュメンテーションコメント
Rust では、ドキュメントがコードと同じくらい重要であると考えられており、ドキュメント作成を支援するツールが標準で提供されています。

### アイテムに対するドキュメント (`///`)
`///` で始まるコメントは、その直後にあるアイテム（関数、構造体、モジュールなど）を説明するドキュメントになります。Markdown 記法が使えます。
```rust
/// Adds one to the number given.
///
/// # Examples
///
/// ```
/// let arg = 5;
/// let answer = my_project::add_one(arg);
///
/// assert_eq!(6, answer);
/// ```
pub fn add_one(x: i32) -> i32 {
    x + 1
}
```
特に、公開 API (`pub` をつけたアイテム) にはドキュメントを書くことが強く推奨されます。良いドキュメントには、以下の要素が含まれます。
1.  **要約:** アイテムが何をするかを簡潔に説明します。
2.  **Examples セクション:** どのように使うかを示すコード例を記述します。これはドキュメンテーションテストとして検証されます。
3.  **Panics セクション:** どのような場合にパニックするかを説明します。
4.  **Errors セクション:** `Result` を返す場合に、どのようなエラーが返される可能性があるかを説明します。

### モジュールに対するドキュメント (`//!`)
`//!` で始まるコメントは、そのコメントが含まれているアイテム（通常はモジュールやクレートのルートファイル）自体を説明します。
```rust
// src/lib.rs

//! # My Crate
//!
//! `my_crate` は、何かを簡単にするためのユーティリティのコレクションです。

/// Adds one to the number given.
// ... (add_one 関数の残りの部分)
```

### `cargo doc`
プロジェクトのルートで `cargo doc --open` を実行すると、Cargo はすべてのドキュメンテーションコメントを解析し、HTML ファイルを生成してブラウザで開いてくれます。これにより、`crates.io` で見るような美しいドキュメントをローカルで確認できます。

## ベストプラクティスとツール

### `rustfmt`: コードフォーマッター
`rustfmt` は、Rust の公式コードフォーマッターです。コードのスタイル（インデント、スペースなど）を、コミュニティで合意された統一された形式に自動で整形してくれます。これにより、スタイルに関する無用な議論を避け、コードの可読性を高めることができます。
```sh
# インストール
rustup component add rustfmt

# プロジェクト内のすべてのファイルをフォーマット
cargo fmt
```

### `clippy`: リンター
`clippy` は、コードを静的に解析し、よくある間違いや非効率なコード、スタイルに一貫性のない部分などを検出して警告してくれるツールです。コンパイラよりも一歩踏み込んだ、非常に有用なアドバイスをくれます。
```sh
# インストール
rustup component add clippy

# プロジェクトをチェック
cargo clippy
```
`clippy` の提案に積極的に従うことで、より Rust らしい（イディオマティックな）コードを書けるようになります。

### API ガイドライン
ライブラリを公開する場合、`crates.io` の API ガイドライン ([https://rust-lang.github.io/api-guidelines/](https://rust-lang.github.io/api-guidelines/)) を参考にすると、他の Rust エコシステムと親和性の高い、使いやすい API を設計するのに役立ちます。

## この章のまとめ
- `///` と `//!` を使って、Markdown 記法でリッチなドキュメントを書くことができる。
- `cargo doc` でドキュメントを生成し、ローカルでプレビューできる。
- コード例はドキュメンテーションテストとして検証され、ドキュメントの品質を保証する。
- `cargo fmt` でコードスタイルを自動で統一する。
- `cargo clippy` でコードの潜在的な問題を検出し、改善のヒントを得る。

## 次の章へ
第4部では、プロジェクトの管理と品質保証について学びました。これで、一人前の Rust プロジェクトを構築・維持するための基礎が固まりました。次の第5部では、Rust の大きな強みの一つである「並行性」と「非同期プログラミング」の世界に飛び込みます。まずは、OS のスレッドを使った基本的な並行処理から始めましょう。

