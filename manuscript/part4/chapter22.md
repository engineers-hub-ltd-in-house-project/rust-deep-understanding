# 第 21 章：ドキュメントコメントと自動コード整形

## この章のゴール
- `///` を使って関数にドキュメンテーションコメントを記述できる。
- `cargo doc --open` を実行し、生成されたHTMLドキュメントをブラウザで確認できる。
- ドキュメント内のコード例が `cargo test` でテストされることを体験する。
- `cargo fmt` を実行して、コードが一貫したスタイルに自動で整形されることを体験する。
- `cargo clippy` を実行して、コードの潜在的な問題を指摘・改善できるようになる。

---

## 21.1 「未来の自分」は他人である

動くコードを書くことは重要ですが、それだけでは十分ではありません。数週間後にそのコードを見返したとき、なぜそのように書いたのか、どう使えばいいのかをすぐに思い出せるでしょうか？良いドキュメントは、未来の自分やチームの他のメンバーへの最高の贈り物です。

Rustは、ドキュメントの作成と維持を非常に重視しており、それを支援する強力なツールが標準で提供されています。

## 21.2 `cargo doc`：コメントからドキュメントを生成する

Rustでは、`///` (トリプルスラッシュ) で始まるコメントは ドキュメンテーションコメント となり、特別な意味を持ちます。このコメントはMarkdownとして解釈され、`cargo doc` コマンドで美しいHTMLドキュメントに変換されます。

### 試してみよう：ドキュメントを書いて、見てみる

前の章で使った `adder` プロジェクトの `src/lib.rs` にドキュメントを追加してみましょう。

```rust
// src/lib.rs

//! # Adder
//! 
//! `adder` は、数値計算、特に足し算を行うためのユーティリティを集めた
//! ライブラリです。（という想定です）

/// 渡された数値に2を加算します。
///
/// # Examples
///
/// ```
/// let arg = 5;
/// let answer = adder::add_two(arg);
///
/// assert_eq!(7, answer);
/// ```
pub fn add_two(a: i32) -> i32 {
    a + 2
}

// ... tests モジュール ...
```
[Rust Playgroundで試す](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&code=//%20src/lib.rs%0A%0A//%21%20%23%20Adder%0A//%21%20%0A//%21%20%60adder%60%20%E3%81%AF%E3%80%81%E6%95%B0%E5%80%A4%E8%A8%88%E7%AE%97%E3%80%81%E7%89%B9%E3%81%AB%E8%B6%B3%E3%81%97%E7%AE%97%E3%82%92%E8%A1%8C%E3%81%86%E3%81%9F%E3%82%81%E3%81%AE%E3%83%A6%E3%83%BC%E3%83%86%E3%82%A3%E3%83%AA%E3%83%86%E3%82%A3%E3%82%92%E9%9B%86%E3%82%81%E3%81%9F%0A//%21%20%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%A7%E3%81%99%E3%80%82%EF%BC%88%E3%81%A8%E3%81%84%E3%81%86%E6%83%B3%E5%AE%9A%E3%81%A7%E3%81%99%EF%BC%89%0A%0A///%20%E6%B8%A1%E3%81%95%E3%82%8C%E3%81%9F%E6%95%B0%E5%80%A4%E3%81%AB2%E3%82%92%E5%8A%A0%E7%AE%97%E3%81%97%E3%81%BE%E3%81%99%E3%80%82%0A///%0A///%20%23%20Examples%0A///%0A///%20%60%60%60%0A///%20let%20arg%20%3D%205%3B%0A///%20let%20answer%20%3D%20adder%3A%3Aadd_two%28arg%29%3B%0A///%0A///%20assert_eq%21%287%2C%20answer%29%3B%0A///%20%60%60%60%0Apub%20fn%20add_two%28a%3A%20i32%29%20-%3E%20i32%20%7B%0A%20%20%20%20a%20%2B%202%0A%7D%0A%0A//%20...%20tests%20%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%20...)
- `///`: その直後にあるアイテム（この場合は `add_two` 関数）を説明します。
- `//!`: そのコメントが含まれているアイテム（この場合はクレート全体）を説明します。

書き終わったら、ターミナルで以下のコマンドを実行してください。

```sh
cargo doc --open
```
自動的にブラウザが立ち上がり、生成されたドキュメントが表示されるはずです。`crates.io` で見るような、プロフェッショナルなドキュメントが手元で簡単に作れることを体験してください。

### ドキュメンテーションテスト：動くドキュメント

`# Examples` セクションに書かれたコードブロックは、ただの例ではありません。`cargo test` を実行すると、このコードブロックは テストとして実行されます。

### 試してみよう：ドキュメンテーションテストを失敗させてみる

`src/lib.rs` のドキュメントを、わざと間違えるように書き換えてみましょう。

```rust
// ...
/// assert_eq!(8, answer); // 7 ではなく 8 にしてみる
// ...
```
[Rust Playgroundで試す](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&code=//%20...%0A///%20assert_eq%21%288%2C%20answer%29%3B%20//%207%20%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%208%20%E3%81%AB%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B%0A//%20...)

この状態で `cargo test` を実行すると、ドキュメンテーションテストが失敗し、`assert_eq` が失敗したときと同じように親切な差分が表示されます。

```text
running 1 test
test src/lib.rs - add_two (line 12) ... FAILED

failures:

---- src/lib.rs - add_two (line 12) stdout ----
thread 'main' panicked at 'assertion failed: `(left == right)`
  left: `8`,
 right: `7`', src/lib.rs:18:1
```

これにより、ドキュメントのコード例が古くなったり、間違ったまま放置されたりすることを防ぎ、「ドキュメントは常に正しい」という信頼性を保証できるのです。

## 21.3 `cargo fmt` と `cargo clippy`：コードの健康診断

良いコードとは、ドキュメントが整備されているだけでなく、スタイルに一貫性があり、よくある間違いが含まれていないコードです。

### `cargo fmt`：自動コードフォーマッター

`rustfmt` は、Rustの公式コードフォーマッターです。`cargo fmt` を実行すると、プロジェクト内のすべてのコードが、コミュニティで合意された統一スタイルに自動で整形されます。インデントやスペースのことで悩む必要はもうありません。

### `cargo clippy`：賢い静的アナライザー

`clippy` は、コードを静的に解析し、よくある間違いや非効率なコード、よりRustらしい書き方を提案してくれるリンターツールです。コンパイラよりも一歩踏み込んだ、経験豊富なプログラマからのアドバイスのようなものです。

### 試してみよう：Clippyの指摘に従ってみる

Clippyがどのような指摘をしてくれるか、わざと非効率なコードを書いて試してみましょう。

```rust
// src/lib.rs のどこかに追加
pub fn slow_add(a: i32, b: i32) -> i32 {
    // Clippy は a + b を推奨するはず
    return a + b;
}
```
[Rust Playgroundで試す](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&code=//%20src/lib.rs%20%E3%81%AE%E3%81%A9%E3%81%93%E3%81%8B%E3%81%AB%E8%BF%BD%E5%8A%A0%0Apub%20fn%20slow_add%28a%3A%20i32%2C%20b%3A%20i32%29%20-%3E%20i32%20%7B%0A%20%20%20%20//%20Clippy%20%E3%81%AF%20a%20%2B%20b%20%E3%82%92%E6%8E%A8%E5%A5%A8%E3%81%99%E3%82%8B%E3%81%AF%E3%81%9A%0A%20%20%20%20return%20a%20%2B%20b%3B%0A%7D)
`cargo clippy` を実行すると、以下のような警告が表示されるはずです。

```text
warning: unneeded `return` statement
  --> src/lib.rs:25:5
   |
25 |     return a + b;
   |     ^^^^^^^^^^^^^
   |
   = note: `#[warn(clippy::needless_return)]` on by default
   = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#needless_return
help: remove `return`
   |
25 -     return a + b;
25 +     a + b
   |
```
このように、Clippyは具体的な修正案まで提示してくれます。定期的に `cargo clippy` を実行し、その提案に従うことは、Rustスキルを向上させるための素晴らしい習慣です。

## 21.4 まとめ

- `cargo doc --open` を使うと、`///` や `//!` で書かれたMarkdownコメントからHTMLドキュメントを簡単に生成できる。
- ドキュメント内の `# Examples` に書かれたコードは `cargo test` で検証され、ドキュメントの信頼性を保証する。
- `cargo fmt` は、議論の余地なくコードスタイルを統一してくれる。
- `cargo clippy` は、コードの品質を向上させるための多くの有益な提案をしてくれる。

---

次の部では、Rustの大きな強みの一つである「並行性」と「非同期プログラミング」の世界に飛び込みます。まずは、OSのスレッドを使った基本的な並行処理から始めましょう。

