# 第 26 章：実践：mini-grep の作成

## この章のゴール
- `std::env::args` を使って、コマンドライン引数を読み込むことができる。
- 環境変数 `IGNORE_CASE=1` を読み取り、検索の挙動を制御できる。
- `eprintln!` を使って、標準出力 (`stdout`) ではなく標準エラー出力 (`stderr`) にエラーメッセージを出力できる。

---

## 26.1 プロジェクトのセットアップと要件定義

`grep` は、ファイルから指定した文字列を検索する、UNIXの古典的で強力なツールです。この章では、その機能をシンプルにした `mini-grep` を作成します。

1.  コマンドライン引数として「検索クエリ」と「ファイルパス」を受け取る。
2.  指定されたファイルを開き、内容を読み込む。
3.  ファイルの内容を一行ずつ走査し、クエリ文字列が含まれる行を標準出力に出力する。
4.  環境変数 `IGNORE_CASE` がセットされていたら、大文字・小文字を区別せずに検索する。

```sh
cargo new mini-grep
```
でプロジェクトを作成しましょう。

## 26.2 コマンドライン引数の受け取り

`std::env::args()` は、プログラムに渡されたコマンドライン引数のイテレータを返します。

この `Args` から引数をパースし、クエリとファイル名を保持する `Config` 構造体を作成します。エラー処理には `Result` を使います。

## 26.3 ファイルの読み込み

`std::fs::read_to_string` は、ファイルパスを受け取り、その内容を `String` として返す便利な関数です。この関数も失敗する可能性があるため、`Result` を返します。

`run` 関数は、`Config` を受け取り、ファイル読み込みなどの主要なロジックを実行します。

## 26.4 ロジックの実装とテスト駆動開発 (TDD)

`mini-grep` の中核となる検索ロジックは、テストを先に書く テスト駆動開発 (TDD: Test-Driven Development) のアプローチで実装してみましょう。

1.  テストを書く: まず、失敗するテストを書きます。
2.  コンパイルを通す: テストがコンパイルできるように、最小限のコード（空の関数など）を書きます。
3.  テストを成功させる: テストが通るように、ロジックを実装します。
4.  リファクタリング: コードをきれいにします。

このサイクルを繰り返すことで、自信を持ってロジックを構築できます。

## 26.5 環境変数による挙動の変更

`std::env::var` は、指定された環境変数の値を `Result<String, VarError>` として返します。この結果を調べて、大文字・小文字を区別しない検索を実装します。

## 26.6 標準エラー出力への書き込み

`println!` は標準出力 (`stdout`) に出力しますが、エラーメッセージや進捗報告は標準エラー出力 (`stderr`) に書くのが一般的です。これにより、ユーザーは `mini-grep result.txt > output.txt` のように、正常な出力だけをファイルにリダイレクトできます。

エラーメッセージには `eprintln!` を使いましょう。

## 26.7 まとめ

- コマンドラインアプリケーションは、`std::env::args` で引数を受け取り、設定用の `struct` にパースするのが一般的なパターン。
- `main` からロジックを分離し、`run` 関数にまとめることで、テストとエラー処理が容易になる。
- `main` は `Result<(), Box<dyn Error>>` を返し、`if let Err(e)` でエラーを処理することで、関心事を分離できる。
- テスト駆動開発 (TDD) は、先にテストを書くことで、自信を持ってロジックを実装し、リファクタリングするための強力な手法。
- `std::env::var` で環境変数を読み取り、プログラムの挙動を柔軟に変更できる。
- エラーメッセージは、`println!` ではなく `eprintln!` で標準エラー出力 (`stderr`) に書き出すべき。

---

`mini-grep` の開発を通して、実践的なコマンドラインアプリケーションの構成要素を学びました。次の章では、Rust のイテレータとクロージャをさらに深く探求し、この `mini-grep` のコードをより効率的で表現力豊かな形にリファクタリングします。
